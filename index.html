<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TRANSTORNOS_PSICOTICOS_SEGUNDA_FONTE</title>
<style>
  :root{--bg:#0f172a;--card:#111827;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--pri:#4f46e5;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.35rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 6px}
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:#0b1220;border:1px solid var(--line);border-radius:10px;padding:10px}
  .info b{display:block;margin-bottom:4px;color:#cbd5e1}

  .q{border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1220;margin-bottom:10px}
  .q h3{margin:0 0 8px;font-size:1rem}
  textarea{width:100%;min-height:80px;resize:vertical;border-radius:10px;border:1px solid var(--line);background:#0a0f1c;color:var(--text);padding:10px}
  .opts{display:flex;flex-wrap:wrap;gap:10px}
  label.opt{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);border-radius:10px;cursor:pointer}
  .opt input[type="radio"]{accent-color:var(--pri)}
  label.opt:has(input[type="radio"]:checked),
  label.opt:has(input[type="checkbox"]:checked){
    background:var(--pri);border-color:var(--pri);color:#fff;font-weight:600;
  }
  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--pri);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
  .errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
  .warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
  .legend{background:#0b1220;border:1px dashed var(--line);border-radius:10px;padding:10px;margin:6px 0 12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>TRANSTORNOS_PSICOTICOS_SEGUNDA_FONTE</h1>
    <p class="muted">
      Este formulário deve ser respondido por alguém próximo ao paciente (familiar, amigo ou cuidador) que o conheça bem, 
      a fim de descrever comportamentos e percepções observadas.  
      Não há respostas certas ou erradas — descreva o que você percebe no dia a dia.
    </p>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>
      <div class="legend muted">As respostas são salvas automaticamente neste dispositivo até o envio final.</div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ======== CONFIG ========
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_TRANSTONOS_PSICOTICOS_SEGUNDA_FONTE" };
const CODE = "TRANSTONOS_PSICOTICOS_SEGUNDA_FONTE";
const SOURCE = "familiares/amigos";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";

// ======== HELPERS ========
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

function setBox(id, text, kind="ok"){const el=$(id);if(!el)return;el.textContent=text;el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");el.style.display="block";}
function hideBox(id){const el=$(id);if(el){el.style.display="none";el.textContent="";}}
function maskCPF(cpf){const d=onlyDigits(cpf||"");if(d.length!==11)return cpf||"";return`${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;}
function fmtDateISO(iso){if(!iso)return"";const[y,m,d]=iso.split("-");return(y&&m&&d)?`${d}/${m}/${y}`:iso;}
async function GET(url){const r=await fetch(url);if(!r.ok)throw new Error("HTTP "+r.status);return r.json();}
async function POST(url,body){const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(!r.ok)throw new Error(await r.text());return r.json();}
async function PATCH(url,body){const r=await fetch(url,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});if(!r.ok)throw new Error(await r.text());return r.json();}
async function sheetSearch(sheet,params){const usp=new URLSearchParams(params);return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);}
async function sheetCreate(sheet,row){return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,{data:[row]});}
async function sheetPatchBy(sheet,column,value,data){return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,{data});}
function goPortalWithToken(){const TOKEN=qs("token");try{const u=new URL(PORTAL_URL,location.href);u.searchParams.set("token",TOKEN);location.href=u.toString();}catch(_){const sep=PORTAL_URL.includes("?")?"&":"?";location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN);}}

// ======== PERGUNTAS ========
const QUESTIONS = [
  "Você já percebeu que o paciente acredita em coisas muito improváveis ou insiste em ideias que parecem fora da realidade?",
  "Ele já comentou ouvir vozes, ver pessoas ou coisas que mais ninguém percebe?",
  "Ele fala sozinho, responde a vozes ou parece escutar algo invisível?",
  "Ele costuma falar de forma confusa, mudar de assunto sem sentido ou ter dificuldade de se fazer entender?",
  "Você percebe que ele se veste, age ou guarda objetos de maneira estranha, diferente do habitual?",
  "Tem ficado mais calado, com o rosto sem expressão ou com dificuldade de demonstrar emoções?",
  "Parece desmotivado, com pouca energia ou sem vontade de fazer as coisas?",
  "Tem se isolado de amigos e familiares, evitando contato e convivência?",
  "Você notou que ele esquece coisas simples, se perde em conversas ou parece desligado?",
  "Tem dificuldade para organizar tarefas ou tomar decisões básicas do dia a dia?",
  "Ele parece não reconhecer que está com algum problema ou não aceita ajuda com facilidade?",
  "Você já viu momentos em que ele fica imóvel, repete gestos ou fala de modo estranho?",
  "Esses comportamentos acontecem há muito tempo ou aparecem em fases específicas?",
  "Você percebeu queda no trabalho, nos estudos ou nas tarefas diárias por causa desses comportamentos?",
  "O paciente já falou sobre se machucar, machucar alguém ou fazer algo perigoso?",
  "Ele já teve atitudes arriscadas, impulsivas ou estranhas que colocaram alguém em perigo?",
  "Ele costuma dormir mal ou passa longos períodos acordado e agitado?",
  "Você percebe relação desses sintomas com uso de álcool ou outras substâncias?",
  "Ele costuma melhorar com descanso, medicação ou apoio de familiares?",
  "Há alguém próximo que o acompanha e ajuda quando está em momentos difíceis?"
];
const OPTIONS = ["Nunca", "Raramente", "Às vezes", "Frequentemente", "Sempre", "Não sei/Não de aplica"];

// ======== RENDER ========
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";
  QUESTIONS.forEach((q,i)=>{
    const n=i+1, qn=`q${String(n).padStart(2,"0")}`;
    const wrap=document.createElement("div");
    wrap.className="q";
    let html=`<h3>${n}. ${q}</h3><div class="opts">`;
    OPTIONS.forEach((opt,idx)=>{
      const id=`${qn}_${idx}`;
      html+=`<label class="opt"><input type="radio" name="${qn}" id="${id}" value="${opt}"><span>${opt}</span></label>`;
    });
    html+=`</div>`;
    wrap.innerHTML=html;
    host.appendChild(wrap);
  });
  host.addEventListener("change",()=>{updateProg();autosaveAnswers();});
  updateProg();
}

function updateProg(){
  const filled=QUESTIONS.filter((_,i)=>document.querySelector(`input[name="q${String(i+1).padStart(2,"0")}"]:checked`)).length;
  $("#progress").textContent=`${filled}/${QUESTIONS.length} respondidas`;
}

// ======== AUTOSAVE ========
function autosaveAnswers(){
  const answers={};
  QUESTIONS.forEach((_,i)=>{
    const qn=`q${String(i+1).padStart(2,"0")}`;
    const sel=document.querySelector(`input[name="${qn}"]:checked`);
    if(sel) answers[qn]=sel.value;
  });
  localStorage.setItem(AUTOSAVE_KEY,JSON.stringify({code:CODE,token:qs("token"),answers}));
}
function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);
    if(!raw)return;
    const {answers}=JSON.parse(raw)||{};
    if(!answers)return;
    Object.entries(answers).forEach(([k,v])=>{
      const el=document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el)el.checked=true;
    });
    updateProg();
  }catch(_){}
}
function clearAutosave(){localStorage.removeItem(AUTOSAVE_KEY);}

// ======== ESTADO ========
let patient=null,CPF="",startAt=Date.now();

// ======== BOOT ========
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){setBox("#alert","Link inválido (sem token).","err");return;}
    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows?.length)throw new Error("Token inválido ou expirado.");
    const tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired=tokenRow.expires_at&&(Date.parse(tokenRow.expires_at)<Date.now());
    if(disabled||expired)throw new Error("Token desativado/expirado.");
    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF)throw new Error("Token sem CPF vinculado.");
    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows?.length)throw new Error("Paciente não encontrado.");
    patient=prows[0];
    const allowed=String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){setBox("#alert","Formulário não liberado para este familiar/amigo.","err");return;}
    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    if(already?.length){setBox("#alert","Formulário já respondido.","ok");setTimeout(goPortalWithToken,1200);return;}
    renderPatientInfo();renderQuestions();
    $("#pacInfo").style.display="grid";$("#form").style.display="block";hideBox("#alert");
    startAt=Date.now();restoreAutosave();
  }catch(err){console.error(err);setBox("#alert",err.message||"Erro ao abrir formulário.","err");}
})();

function renderPatientInfo(){
  const g=$("#pacInfo");g.innerHTML="";
  [["Nome",patient.nome||"-"],["CPF",maskCPF(patient.cpf)],["Data de nascimento",fmtDateISO(patient.data_nascimento)]].forEach(([k,v])=>{
    const d=document.createElement("div");d.className="info";d.innerHTML=`<b>${k}</b><div>${v}</div>`;g.appendChild(d);
  });
}

// ======== SUBMIT ========
let sending=false;
$("#form").addEventListener("submit",async e=>{
  e.preventDefault();if(sending)return;sending=true;hideBox("#msg");
  const btn=$("#btnSubmit"),orig=btn.textContent;btn.disabled=true;btn.textContent="Enviando…";
  try{
    const answers={};
    const qaList=QUESTIONS.map((q,i)=>{
      const qn=`q${String(i+1).padStart(2,"0")}`;
      const sel=document.querySelector(`input[name="${qn}"]:checked`);
      const val=sel?sel.value:"(sem resposta)";
      answers[qn]=val;
      return {n:i+1,q,raw:val};
    });
    const total=Object.values(answers).filter(v=>v!=="(sem resposta)").length;
    const categoria=`${total}/${QUESTIONS.length} respondidas`;
    const row={
      result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
      token:qs("token"),
      cpf:patient.cpf,
      code:CODE,
      source:SOURCE,
      submitted_at:new Date().toISOString(),
      questions:JSON.stringify(qaList),
      categoria,
      metrics:JSON.stringify({total,answers})
    };
    await sheetCreate(SHEETS.SCORES,row);
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,{[`${CODE}_FEITO`]:"sim",[`${CODE}_FEITO_AT`]:new Date().toISOString()});
    clearAutosave();
    setBox("#msg","Respostas enviadas com sucesso. Retornando ao portal…","ok");
    setTimeout(goPortalWithToken,1500);
  }catch(err){
    console.error(err);
    setBox("#msg",err.message||"Falha ao enviar.","err");
    sending=false;btn.disabled=false;btn.textContent=orig;
  }
});
</script>
</body>
</html>
